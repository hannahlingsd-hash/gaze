<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Motion Sound</title>
<style>
  body{margin:0;background:#000;color:#fff;font-family:sans-serif;text-align:center}
  video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  #controls{position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:10}
  button{margin:0 4px;padding:6px 12px}
</style>
</head>
<body>
<div id="controls">
  <button id="start">Start Camera</button>
  <button id="sound">Enable Sound</button>
</div>
<video id="video" autoplay playsinline muted></video>
<canvas id="canvas"></canvas>

<script>
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d',{willReadFrequently:true});
let w,h,lastFrame,ac,gain,osc,motion=0,speed=0,lastCentroid=null;

document.getElementById('start').onclick=async()=>{
  const s=await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject=s;
  video.onloadedmetadata=()=>{w=video.videoWidth;h=video.videoHeight;canvas.width=w;canvas.height=h;loop();}
};

document.getElementById('sound').onclick=()=>{
  ac=new (window.AudioContext||window.webkitAudioContext)();
  gain=ac.createGain();gain.gain.value=0;gain.connect(ac.destination);
  osc=ac.createOscillator();osc.type='sine';osc.frequency.value=220;osc.connect(gain);osc.start();
};

function loop(){
  requestAnimationFrame(loop);
  if(!w||!h) return;
  ctx.drawImage(video,0,0,w,h);
  const img=ctx.getImageData(0,0,w,h);
  if(!lastFrame){lastFrame=img;return;}
  let changed=0,sumx=0,sumy=0;
  for(let i=0;i<img.data.length;i+=4){
    const d=Math.abs(img.data[i]-lastFrame.data[i])+Math.abs(img.data[i+1]-lastFrame.data[i+1])+Math.abs(img.data[i+2]-lastFrame.data[i+2]);
    if(d>60){changed++;const p=i/4;sumx+=p%w;sumy+=Math.floor(p/w);}
  }
  const m=changed/(w*h)*100;
  if(changed>0){
    const cx=sumx/changed,cy=sumy/changed;
    if(lastCentroid){const dx=cx-lastCentroid.x,dy=cy-lastCentroid.y;speed=Math.sqrt(dx*dx+dy*dy)/w;}
    lastCentroid={x:cx,y:cy};
  }
  motion=motion*0.8+m*0.2;
  if(ac){
    const vol=Math.min(1,motion/5);
    const rate=1+Math.min(2,speed*5);
    gain.gain.linearRampToValueAtTime(vol,ac.currentTime+0.05);
    osc.frequency.linearRampToValueAtTime(200*rate,ac.currentTime+0.05);
  }
  lastFrame=img;
}
</script>
</body>
</html>
